<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é¡µé¢ - ECharts å’Œ WebSocket</title>
    <script src="/static/libs/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .chart { width: 100%; height: 300px; border: 1px solid #ccc; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; background: #f0f0f0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å‰ç«¯æµ‹è¯•é¡µé¢</h1>

        <div class="status" id="status">
            çŠ¶æ€: ç­‰å¾…æµ‹è¯•...
        </div>

        <button onclick="testECharts()">æµ‹è¯• ECharts</button>
        <button onclick="testWebSocket()">æµ‹è¯• WebSocket</button>
        <button onclick="testDataFlow()">æµ‹è¯•æ•°æ®æµ</button>

        <div class="chart" id="testChart"></div>

        <div id="results"></div>
    </div>

    <script>
        let chart = null;
        let ws = null;

        function setStatus(message) {
            document.getElementById('status').textContent = 'çŠ¶æ€: ' + message;
            console.log(message);
        }

        function addResult(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        function testECharts() {
            setStatus('æ­£åœ¨æµ‹è¯• ECharts...');

            try {
                chart = echarts.init(document.getElementById('testChart'));

                const option = {
                    title: { text: 'ECharts æµ‹è¯•å›¾è¡¨' },
                    tooltip: {},
                    xAxis: { data: ['A', 'B', 'C', 'D', 'E'] },
                    yAxis: {},
                    series: [{ type: 'line', data: [10, 20, 30, 40, 50] }]
                };

                chart.setOption(option);

                setStatus('âœ… ECharts æµ‹è¯•æˆåŠŸ');
                addResult('âœ… ECharts åˆå§‹åŒ–æˆåŠŸ');

            } catch (error) {
                setStatus('âŒ ECharts æµ‹è¯•å¤±è´¥');
                addResult('âŒ ECharts é”™è¯¯: ' + error.message);
                console.error('ECharts é”™è¯¯:', error);
            }
        }

        function testWebSocket() {
            setStatus('æ­£åœ¨æµ‹è¯• WebSocket...');

            try {
                ws = new WebSocket('ws://localhost:8000/ws/stream');

                ws.onopen = function() {
                    setStatus('âœ… WebSocket è¿æ¥æˆåŠŸ');
                    addResult('âœ… WebSocket è¿æ¥æˆåŠŸ');

                    // å‘é€æ’­æ”¾è¯·æ±‚
                    fetch('/api/control/play', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            addResult('âœ… æ’­æ”¾æ§åˆ¶æˆåŠŸ: ' + JSON.stringify(data));
                        })
                        .catch(error => {
                            addResult('âŒ æ’­æ”¾æ§åˆ¶å¤±è´¥: ' + error.message);
                        });
                };

                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    addResult('âœ… æ”¶åˆ°æ•°æ®: ' + JSON.stringify(data[0]));

                    // æ›´æ–°å›¾è¡¨
                    if (chart && data && data.length > 0) {
                        const record = data[0];
                        chart.setOption({
                            series: [{ data: [record.pm25, record.pm10, record.co, record.temperature, record.humidity] }]
                        });
                    }
                };

                ws.onerror = function(error) {
                    setStatus('âŒ WebSocket è¿æ¥é”™è¯¯');
                    addResult('âŒ WebSocket é”™è¯¯: ' + error);
                };

                ws.onclose = function() {
                    addResult('â„¹ï¸ WebSocket è¿æ¥å·²å…³é—­');
                };

            } catch (error) {
                setStatus('âŒ WebSocket æµ‹è¯•å¤±è´¥');
                addResult('âŒ WebSocket é”™è¯¯: ' + error.message);
                console.error('WebSocket é”™è¯¯:', error);
            }
        }

        function testDataFlow() {
            setStatus('æ­£åœ¨æµ‹è¯•æ•°æ®æµ...');

            fetch('/api/latest?limit=1')
                .then(response => response.json())
                .then(data => {
                    if (data.data && data.data.length > 0) {
                        const record = data.data[0].records[0].values;
                        addResult('âœ… æ•°æ®æµæµ‹è¯•æˆåŠŸ: ' + JSON.stringify(record));
                        setStatus('âœ… æ•°æ®æµæµ‹è¯•æˆåŠŸ');
                    } else {
                        addResult('âŒ æ•°æ®æµæµ‹è¯•å¤±è´¥: æ²¡æœ‰æ•°æ®');
                        setStatus('âŒ æ•°æ®æµæµ‹è¯•å¤±è´¥');
                    }
                })
                .catch(error => {
                    addResult('âŒ æ•°æ®æµæµ‹è¯•å¤±è´¥: ' + error.message);
                    setStatus('âŒ æ•°æ®æµæµ‹è¯•å¤±è´¥');
                });
        }

        // é¡µé¢åŠ è½½æ—¶çš„æµ‹è¯•
        window.onload = function() {
            setStatus('é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡æµ‹è¯•...');
            addResult('â„¹ï¸ æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—');
        };
    </script>
</body>
</html>
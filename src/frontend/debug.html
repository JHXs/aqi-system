<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å°åŒ–è°ƒè¯•é¡µé¢</title>
    <script src="/static/libs/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chart { width: 100%; height: 300px; border: 1px solid #ccc; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; background: #f0f0f0; }
        button { padding: 10px 20px; margin: 5px; }
        .container { max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœ€å°åŒ–è°ƒè¯•é¡µé¢ï¼ˆåŸºäº index.htmlï¼‰</h1>

        <div class="status" id="status">
            çŠ¶æ€: ç­‰å¾…è°ƒè¯•...
        </div>

        <button onclick="connect()">è¿æ¥</button>
        <button onclick="play()">æ’­æ”¾</button>
        <button onclick="pause()">æš‚åœ</button>
        <button onclick="reset()">é‡ç½®</button>

        <div class="chart" id="pm25Chart"></div>
        <div class="chart" id="pm10Chart"></div>
        <div class="chart" id="coChart"></div>

        <div class="data-grid">
            <div class="data-item">
                <span class="data-label">PM2.5:</span>
                <span id="pm25Value" class="data-value">--</span>
                <span class="data-unit">Î¼g/mÂ³</span>
            </div>
            <div class="data-item">
                <span class="data-label">PM10:</span>
                <span id="pm10Value" class="data-value">--</span>
                <span class="data-unit">Î¼g/mÂ³</span>
            </div>
            <div class="data-item">
                <span class="data-label">CO:</span>
                <span id="coValue" class="data-value">--</span>
                <span class="data-unit">mg/mÂ³</span>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        let socket = null;
        let isConnected = false;
        let isPlaying = false;
        let pm25Chart = null;
        let pm10Chart = null;
        let coChart = null;
        let timeData = [];
        let pm25Data = [];
        let pm10Data = [];
        let coData = [];
        let aqiData = [];
        let tempData = [];
        let humidityData = [];
        const MAX_POINTS = 100;

        function setStatus(message) {
            document.getElementById('status').textContent = 'çŠ¶æ€: ' + message;
            console.log(message);
        }

        function addResult(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        // åˆå§‹åŒ–å›¾è¡¨ï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        function initCharts() {
            setStatus('æ­£åœ¨åˆå§‹åŒ–å›¾è¡¨...');

            try {
                // PM2.5å›¾è¡¨
                pm25Chart = echarts.init(document.getElementById('pm25Chart'));
                pm25Chart.setOption({
                    title: { text: 'PM2.5 (Î¼g/mÂ³)' },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'category', boundaryGap: false, data: timeData },
                    yAxis: { type: 'value', name: 'Î¼g/mÂ³' },
                    series: [{ name: 'PM2.5', type: 'line', smooth: true, data: pm25Data }]
                });

                // PM10å›¾è¡¨
                pm10Chart = echarts.init(document.getElementById('pm10Chart'));
                pm10Chart.setOption({
                    title: { text: 'PM10 (Î¼g/mÂ³)' },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'category', boundaryGap: false, data: timeData },
                    yAxis: { type: 'value', name: 'Î¼g/mÂ³' },
                    series: [{ name: 'PM10', type: 'line', smooth: true, data: pm10Data }]
                });

                // COå›¾è¡¨
                coChart = echarts.init(document.getElementById('coChart'));
                coChart.setOption({
                    title: { text: 'CO (mg/mÂ³)' },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'category', boundaryGap: false, data: timeData },
                    yAxis: { type: 'value', name: 'mg/mÂ³' },
                    series: [{ name: 'CO', type: 'line', smooth: true, data: coData }]
                });

                setStatus('âœ… å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
                addResult('âœ… å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');

            } catch (error) {
                setStatus('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥');
                addResult('âŒ å›¾è¡¨åˆå§‹åŒ–é”™è¯¯: ' + error.message);
                console.error('å›¾è¡¨åˆå§‹åŒ–é”™è¯¯:', error);
            }
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®ï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        function processData(data) {
            if (!data || !data.timestamp) return;

            try {
                // æ·»åŠ æ•°æ®åˆ°æ•°ç»„
                timeData.push(formatTime(data.timestamp));
                pm25Data.push(data.pm25 || 0);
                pm10Data.push(data.pm10 || 0);
                coData.push(data.co || 0);
                tempData.push(data.temperature || 0);
                humidityData.push(data.humidity || 0);

                // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
                if (timeData.length > MAX_POINTS) {
                    timeData.shift();
                    pm25Data.shift();
                    pm10Data.shift();
                    coData.shift();
                    tempData.shift();
                    humidityData.shift();
                }

                // æ›´æ–°å›¾è¡¨
                updateCharts();

                // æ›´æ–°å®æ—¶æ•°æ®æ˜¾ç¤º
                updateRealTimeData(data);

                addResult('âœ… å¤„ç†æ•°æ®: ' + JSON.stringify({
                    timestamp: data.timestamp,
                    pm25: data.pm25,
                    pm10: data.pm10,
                    co: data.co
                }));

            } catch (error) {
                addResult('âŒ å¤„ç†æ•°æ®é”™è¯¯: ' + error.message);
                console.error('å¤„ç†æ•°æ®é”™è¯¯:', error);
            }
        }

        // æ›´æ–°å›¾è¡¨ï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        function updateCharts() {
            try {
                pm25Chart.setOption({ xAxis: { data: timeData }, series: [{ data: pm25Data }] });
                pm10Chart.setOption({ xAxis: { data: timeData }, series: [{ data: pm10Data }] });
                coChart.setOption({ xAxis: { data: timeData }, series: [{ data: coData }] });
            } catch (error) {
                addResult('âŒ æ›´æ–°å›¾è¡¨é”™è¯¯: ' + error.message);
                console.error('æ›´æ–°å›¾è¡¨é”™è¯¯:', error);
            }
        }

        // æ›´æ–°å®æ—¶æ•°æ®æ˜¾ç¤ºï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        function updateRealTimeData(data) {
            try {
                document.getElementById('pm25Value').textContent = data.pm25 ? data.pm25.toFixed(1) : '--';
                document.getElementById('pm10Value').textContent = data.pm10 ? data.pm10.toFixed(1) : '--';
                document.getElementById('coValue').textContent = data.co ? data.co.toFixed(1) : '--';
            } catch (error) {
                addResult('âŒ æ›´æ–°æ•°æ®æ˜¾ç¤ºé”™è¯¯: ' + error.message);
                console.error('æ›´æ–°æ•°æ®æ˜¾ç¤ºé”™è¯¯:', error);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        // è¿æ¥WebSocketï¼ˆå¤åˆ¶è‡ª app.jsï¼‰
        function connectWebSocket() {
            const connectBtn = document.getElementById('connectBtn');
            const connectionStatus = document.getElementById('connectionStatus');

            if (!isConnected) {
                try {
                    socket = new WebSocket('ws://localhost:8000/ws/stream');

                    socket.onopen = function() {
                        isConnected = true;
                        setStatus('âœ… WebSocket è¿æ¥æˆåŠŸ');
                        addResult('âœ… WebSocket å·²è¿æ¥');

                        // è‡ªåŠ¨å¼€å§‹æ’­æ”¾
                        play();
                    };

                    socket.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        if (data && data.length > 0) {
                            processData(data[0]);
                        }
                    };

                    socket.onclose = function() {
                        isConnected = false;
                        setStatus('âŒ WebSocket å·²æ–­å¼€');
                        addResult('âŒ WebSocket è¿æ¥å·²å…³é—­');
                    };

                    socket.onerror = function(error) {
                        setStatus('âŒ WebSocket è¿æ¥é”™è¯¯');
                        addResult('âŒ WebSocket é”™è¯¯: ' + error);
                    };

                } catch (error) {
                    setStatus('âŒ è¿æ¥å¤±è´¥');
                    addResult('âŒ è¿æ¥é”™è¯¯: ' + error.message);
                }
            } else {
                if (socket) {
                    socket.close();
                }
            }
        }

        // æ§åˆ¶å‡½æ•°
        function connect() {
            connectWebSocket();
        }

        function play() {
            if (!isConnected) {
                addResult('âŒ è¯·å…ˆè¿æ¥ WebSocket');
                return;
            }

            isPlaying = true;
            fetch('/api/control/play', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    setStatus('âœ… å¼€å§‹æ’­æ”¾');
                    addResult('âœ… æ’­æ”¾æ§åˆ¶: ' + JSON.stringify(data));
                })
                .catch(error => {
                    addResult('âŒ æ’­æ”¾æ§åˆ¶é”™è¯¯: ' + error.message);
                });
        }

        function pause() {
            if (!isConnected) return;

            isPlaying = false;
            fetch('/api/control/pause', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    setStatus('â¸ï¸ æš‚åœæ’­æ”¾');
                    addResult('â¸ï¸ æš‚åœæ§åˆ¶: ' + JSON.stringify(data));
                })
                .catch(error => {
                    addResult('âŒ æš‚åœæ§åˆ¶é”™è¯¯: ' + error.message);
                });
        }

        function reset() {
            if (!isConnected) return;

            timeData = [];
            pm25Data = [];
            pm10Data = [];
            coData = [];
            tempData = [];
            humidityData = [];

            updateCharts();
            updateRealTimeData({});
            setStatus('ğŸ”„ æ•°æ®å·²é‡ç½®');

            fetch('/api/control/reset', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    addResult('ğŸ”„ é‡ç½®æ§åˆ¶: ' + JSON.stringify(data));
                })
                .catch(error => {
                    addResult('âŒ é‡ç½®æ§åˆ¶é”™è¯¯: ' + error.message);
                });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initCharts();
            setStatus('é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»è¿æ¥æŒ‰é’®');
            addResult('â„¹ï¸ æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—');
        };
    </script>
</body>
</html>